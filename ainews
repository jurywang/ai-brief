import os
import requests
from datetime import datetime, timedelta
import warnings

# å¿½ç•¥SSLè­¦å‘Š
warnings.filterwarnings('ignore', message='Unverified HTTPS request')

# ========== é…ç½®åŒºåŸŸ ==========
# ä» GitHub Secrets å®‰å…¨è¯»å– Key
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY") 
OUTPUT_FILE = "index.html" 
DISABLE_SSL_VERIFY = True 

def generate_daily_brief():
    if not DEEPSEEK_API_KEY:
        print("âŒ é”™è¯¯: æœªåœ¨ç¯å¢ƒå˜é‡ä¸­æ‰¾åˆ° DEEPSEEK_API_KEY")
        return

    now = datetime.now()
    today_str = now.strftime("%Yå¹´%mæœˆ%dæ—¥")
    three_days_ago = (now - timedelta(days=3)).strftime("%Yå¹´%mæœˆ%dæ—¥")
    
    prompt = f"""
    ä½ æ˜¯ä¸€ä½é¡¶çº§çš„UI/UXè®¾è®¡å¸ˆå’Œç§‘æŠ€æ–°é—»ç¼–è¾‘ã€‚è¯·ç”Ÿæˆä» {three_days_ago} åˆ° {today_str} çš„ AI è¡Œä¸šç®€æŠ¥ã€‚

    ### ä»»åŠ¡è¦æ±‚ï¼š
    1. æ±‡æ€»è¿‡å» 72 å°æ—¶å†…çš„å…¨çƒ AI åŠ¨æ€ï¼ˆé‡ç‚¹å…³æ³¨ä¸»æµå‚å•†åŠæ¨¡å‹å‘å¸ƒï¼‰ã€‚
    2. **é“¾æ¥å¯é æ€§**ï¼šæ¯ä¸ªå¡ç‰‡å¿…é¡»åŒ…å«çœŸå®æ¥æº URLã€‚è‹¥æ— é•¿é“¾æ¥ï¼Œè¯·é“¾æ¥è‡³è¯¥åª’ä½“å®˜ç½‘ã€‚
    3. **æ˜æ–‡æ˜¾ç¤ºæ¥æº**ï¼šå¡ç‰‡åº•éƒ¨å¿…é¡»æ ‡æ³¨ "æ¥æºï¼š[åª’ä½“åç§°]"ã€‚

    ### è®¾è®¡é£æ ¼ï¼š
    - **èƒŒæ™¯**ï¼šçº¯ç™½è‰² (#FFFFFF)ï¼›**å­—ä½“**ï¼šPoppinsã€‚
    - **è§†è§‰**ï¼šè“è‰²åˆ°ç´«è‰²çš„æ¸å˜æ¸å˜æ ‡é¢˜ã€‚
    - **äº¤äº’**ï¼šå¡ç‰‡å¸¦æŸ”å’Œé˜´å½±ï¼Œæ‚¬åœæ—¶å‘ä¸Šä½ç§»å¹¶è½»å¾®æ”¾å¤§ã€‚
    - **ç»“æ„**ï¼šæ ¸å¿ƒç„¦ç‚¹(3æ¡)ã€æŠ€æœ¯åŠ¨æ€ã€å•†ä¸šå¸‚åœºã€æˆ˜ç•¥å¯ç¤ºã€‚
    """

    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}"
    }
    
    data = {
        "model": "deepseek-chat",
        "messages": [
            {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“æ³¨äºè§†è§‰ä½“éªŒçš„ HTML ä»£ç ç”Ÿæˆå™¨ã€‚ç›´æ¥è¾“å‡ºä»£ç ï¼Œä¸åŒ…å« Markdown æ ‡è®°ã€‚"},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.3
    }
    
    try:
        print(f"ğŸš€ æ­£åœ¨æ•´ç† 72 å°æ—¶å†…åŠ¨æ€...")
        response = requests.post(
            "https://api.deepseek.com/v1/chat/completions",
            headers=headers,
            json=data,
            timeout=120,
            verify=not DISABLE_SSL_VERIFY
        )
        response.raise_for_status()
        html_content = response.json()['choices'][0]['message']['content']
        
        # è‡ªåŠ¨æ¸…æ´— Markdown æ ‡ç­¾
        html_content = html_content.replace('```html', '').replace('```', '').strip()
        
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            f.write(html_content)
        print(f"âœ… index.html ç”ŸæˆæˆåŠŸï¼")
        
    except Exception as e:
        print(f"âŒ è¿è¡Œå¤±è´¥: {e}")

if __name__ == "__main__":
    generate_daily_brief()
